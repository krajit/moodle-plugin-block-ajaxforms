{"version":3,"file":"formhandler.min.js","sources":["../src/formhandler.js"],"sourcesContent":["define(['jquery', 'core/ajax', 'core/notification'], function($, Ajax, Notification) {\n    return {\n        init: function(params) {\n            const levelColors = {\n                \"Not Started\": \"#f8d7da\",\n                \"Fresh\": \"#fce5cd\",\n                \"Learning\": \"#fff3cd\",\n                \"Expert\": \"#d1ecf1\",\n                \"Done\": \"#d4edda\"\n            };\n\n            function updateLevelColor() {\n                const levelSelect = document.getElementById('learninglevel');\n                const selectedLevel = levelSelect?.value;\n                if (selectedLevel && levelColors[selectedLevel]) {\n                    levelSelect.style.backgroundColor = levelColors[selectedLevel];\n                } else if (levelSelect) {\n                    levelSelect.style.backgroundColor = 'white';\n                }\n            }\n\n            function updateProgressBar() {\n                const revisionInput = document.getElementById('revisioncount');\n                const targetInput = document.getElementById('targetcount');\n                const progressBar = document.getElementById('progressBar');\n\n                const revisioncount = parseInt(revisionInput?.value || 0);\n                const targetcount = parseInt(targetInput?.value || 1);\n                const percent = Math.min(100, Math.round((revisioncount / targetcount) * 100));\n                if (progressBar) {\n                    progressBar.style.width = percent + '%';\n                    progressBar.textContent = percent + '%';\n                }\n            }\n\n            function saveData() {\n                var date = $('#nextReview').val();\n                const learninglevel = $('#learninglevel').val();\n                const revisioncount = $('#revisioncount').val();\n                const targetcount = $('#targetcount').val();\n                const pageurl = window.location.pathname + window.location.search;\n\n                if (!date) {\n                    date = '';\n                    //window.console.log(\"date cleared. TODO: Update when to delete page row from the table\");\n                }\n                Ajax.call([{\n                    methodname: 'block_revisionmanager_save_entry',\n                    args: {\n                        nextreview: date,\n                        pageurl: pageurl,\n                        courseid: params.courseid,\n                        pagetitle: params.pagetitle,\n                        learninglevel: learninglevel,\n                        revisioncount: revisioncount,\n                        targetcount: targetcount,\n                    },\n                    done: function(response) {\n                        console.log('Saved:', response.status);\n                    },\n                    fail: Notification.exception\n                }]);\n                \n            }\n\n            function loadExistingData() {\n                const pageurl = window.location.pathname + window.location.search;\n\n                Ajax.call([{\n                    methodname: 'block_revisionmanager_get_entry',\n                    args: { \n                        pageurl: pageurl,\n                        courseid: params.courseid\n                    },\n                    done: function(data) {\n                        if (data.nextreview) {\n                            $('#nextReview').val(data.nextreview);\n                        }\n                        if (data.learninglevel) {\n                            $('#learninglevel').val(data.learninglevel);\n                            updateLevelColor();\n                        }\n                        if (data.revisioncount) {\n                            $('#revisioncount').val(data.revisioncount);\n                        }\n                        if (data.targetcount) {\n                            $('#targetcount').val(data.targetcount);\n                        }\n                        updateProgressBar();\n                    },\n                    fail: Notification.exception\n                }]);\n            }\n\n            \n\n            // Attach listeners for autosave\n            $('#nextReview').on('input change', saveData);\n            $('#learninglevel').on('input change', function() {\n                updateLevelColor();\n                saveData();\n            });\n            $('#revisioncount').on('input change', function() {\n                updateProgressBar();\n                saveData();\n            });\n            $('#targetcount').on('input change', function() {\n                updateProgressBar();\n                saveData();\n            });\n\n            // Initial setup\n            updateLevelColor();\n            updateProgressBar();\n            loadExistingData();\n        \n            // Add after loadExistingData()\n\n            function setupRatingPopup() {\n                const container = document.getElementById('rating-container');\n                const popup = document.getElementById('rating-popup');\n                const dateInput = document.getElementById('rating-date');\n                const valueInput = document.getElementById('rating-value');\n                const saveBtn = document.getElementById('rating-save');\n\n                let currentButton = null;\n\n                container.querySelectorAll('.rating-btn').forEach(button => {\n                    button.addEventListener('click', function(e) {\n                        currentButton = this;\n\n                        // Fill form with current values\n                        valueInput.value = this.dataset.rating;\n                        dateInput.value = this.dataset.date || new Date().toISOString().split('T')[0];\n\n                        // Position popup below button\n                        const rect = this.getBoundingClientRect();\n                        const containerRect = container.getBoundingClientRect();\n\n                        popup.style.position = 'absolute';\n                        popup.style.left = `${rect.left - containerRect.left}px`;\n                        popup.style.top = `${rect.top - containerRect.top + 45}px`;\n                        popup.style.display = 'block';\n                    });\n                });\n\n                // Save logic\n                saveBtn.addEventListener('click', function() {\n                    if (currentButton) {\n                        const newRating = valueInput.value;\n                        const newDate = dateInput.value;\n\n                        currentButton.textContent = newRating;\n                        currentButton.dataset.rating = newRating;\n                        currentButton.dataset.date = newDate;\n\n                        popup.style.display = 'none';\n\n                                                    // Remove old color classes\n                            currentButton.classList.remove('bg-danger', 'bg-warning', 'bg-success', 'bg-orange', 'bg-lightgreen');\n\n                            // Add based on rating\n                            let rating = parseInt(newRating);\n                            if (rating === 1) {\n                                currentButton.classList.add('bg-danger', 'text-white');\n                            } else if (rating === 2) {\n                                currentButton.classList.add('bg-orange', 'text-white');\n                            } else if (rating === 3) {\n                                currentButton.classList.add('bg-warning', 'text-dark');\n                            } else if (rating === 4) {\n                                currentButton.classList.add('bg-lightgreen', 'text-white');\n                            } else if (rating === 5) {\n                                currentButton.classList.add('bg-success', 'text-white');\n                            }\n\n                        // TODO: Add save to DB if needed\n                        console.log(`Saved: ${newRating} on ${newDate}`);\n                    }\n                });\n\n                // Hide if clicked outside\n                document.addEventListener('click', function(e) {\n                    if (!popup.contains(e.target) && !e.target.classList.contains('rating-btn')) {\n                        popup.style.display = 'none';\n                    }\n                });\n            }\n\n            // Then call setupRatingPopup() at the end of init()\n            setupRatingPopup();\n\n        \n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","init","params","levelColors","updateLevelColor","levelSelect","document","getElementById","selectedLevel","value","style","backgroundColor","updateProgressBar","revisionInput","targetInput","progressBar","revisioncount","parseInt","targetcount","percent","Math","min","round","width","textContent","saveData","date","val","learninglevel","pageurl","window","location","pathname","search","call","methodname","args","nextreview","courseid","pagetitle","done","response","console","log","status","fail","exception","on","data","loadExistingData","container","popup","dateInput","valueInput","saveBtn","currentButton","querySelectorAll","forEach","button","addEventListener","e","this","dataset","rating","Date","toISOString","split","rect","getBoundingClientRect","containerRect","position","left","top","display","newRating","newDate","classList","remove","add","contains","target","setupRatingPopup"],"mappings":"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"}