{"version":3,"file":"databasecommunicator.min.js","sources":["../src/databasecommunicator.js"],"sourcesContent":["// blocks/revisionmanager/amd/src/datacommunicator.js\n\ndefine(['jquery', 'core/ajax', 'core/notification'], function($, Ajax, Notification) {\n    return {\n        init: function(params) {\n            const grid = document.getElementById('rating-grid');\n            const plusBtn = document.getElementById('plusBtn');\n            const popup = document.getElementById('rating-popup');\n            const dateInput = document.getElementById('rating-date');\n            const valueInput = document.getElementById('rating-value');\n            const saveBtn = document.getElementById('rating-save');\n\n            // === Show popup when clicking plus button ===\n            plusBtn?.addEventListener('click', (e) => {\n                const rect = plusBtn.getBoundingClientRect();\n                const containerRect = grid.getBoundingClientRect();\n                popup.style.position = 'absolute';\n                popup.style.left = `${rect.left - containerRect.left + grid.scrollLeft}px`;\n                popup.style.top = `${rect.top - containerRect.top + 45}px`;\n                popup.style.display = 'block';\n                dateInput.valueAsDate = new Date();\n                valueInput.value = '';\n            });\n\n            // === Save new rating to server ===\n            saveBtn?.addEventListener('click', () => {\n                const rating = parseInt(valueInput.value);\n                const date = dateInput.value;\n\n                if (isNaN(rating) || rating < 0 || rating > 5) {\n                    alert(\"Please enter a rating between 0 and 5\");\n                    return;\n                }\n\n                const timestamp = Math.floor(new Date(date).getTime() / 1000);\n\n                Ajax.call([{\n                    methodname: 'block_revisionmanager_save_rating',\n                    args: {\n                        courseid: params.courseid,\n                        pageid: params.pageid,\n                        ratingvalue: rating,\n                        ratingdate: timestamp\n                    },\n                    done: function() {\n                        const div = document.createElement('div');\n                        div.className = `rating-square bg-rating-${rating}`;\n                        div.textContent = rating;\n                        div.title = `Date: ${date}`;\n\n                        grid.insertBefore(div, plusBtn);\n                        popup.style.display = 'none';\n                    },\n                    fail: Notification.exception\n                }]);\n            });\n\n            // === Hide popup if clicking outside ===\n            document.addEventListener('click', (e) => {\n                if (!popup.contains(e.target) && e.target !== plusBtn) {\n                    popup.style.display = 'none';\n                }\n            });\n\n            // === Load existing ratings from server ===\n            Ajax.call([{\n                methodname: 'block_revisionmanager_get_ratings',\n                args: {\n                    courseid: params.courseid,\n                    pageid: params.pageid\n                },\n                done: function(ratings) {\n                    ratings.forEach(r => {\n                        const d = new Date(r.ratingdate * 1000);\n                        const dateStr = d.toISOString().split('T')[0];\n\n                        const div = document.createElement('div');\n                        div.className = `rating-square bg-rating-${r.ratingvalue}`;\n                        div.textContent = r.ratingvalue;\n                        div.title = `Date: ${dateStr}`;\n                        grid.insertBefore(div, plusBtn);\n                    });\n                },\n                fail: Notification.exception\n            }]);\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","init","params","grid","document","getElementById","plusBtn","popup","dateInput","valueInput","saveBtn","addEventListener","e","rect","getBoundingClientRect","containerRect","style","position","left","scrollLeft","top","display","valueAsDate","Date","value","rating","parseInt","date","isNaN","alert","timestamp","Math","floor","getTime","call","methodname","args","courseid","pageid","ratingvalue","ratingdate","done","div","createElement","className","textContent","title","insertBefore","fail","exception","contains","target","ratings","forEach","r","dateStr","toISOString","split"],"mappings":"AAEAA,oDAAO,CAAC,SAAU,YAAa,sBAAsB,SAASC,EAAGC,KAAMC,oBAC5D,CACHC,KAAM,SAASC,cACLC,KAAOC,SAASC,eAAe,eAC/BC,QAAUF,SAASC,eAAe,WAClCE,MAAQH,SAASC,eAAe,gBAChCG,UAAYJ,SAASC,eAAe,eACpCI,WAAaL,SAASC,eAAe,gBACrCK,QAAUN,SAASC,eAAe,eAGxCC,MAAAA,SAAAA,QAASK,iBAAiB,SAAUC,UAC1BC,KAAOP,QAAQQ,wBACfC,cAAgBZ,KAAKW,wBAC3BP,MAAMS,MAAMC,SAAW,WACvBV,MAAMS,MAAME,eAAUL,KAAKK,KAAOH,cAAcG,KAAOf,KAAKgB,iBAC5DZ,MAAMS,MAAMI,cAASP,KAAKO,IAAML,cAAcK,IAAM,SACpDb,MAAMS,MAAMK,QAAU,QACtBb,UAAUc,YAAc,IAAIC,KAC5Bd,WAAWe,MAAQ,MAIvBd,MAAAA,SAAAA,QAASC,iBAAiB,SAAS,WACzBc,OAASC,SAASjB,WAAWe,OAC7BG,KAAOnB,UAAUgB,SAEnBI,MAAMH,SAAWA,OAAS,GAAKA,OAAS,cACxCI,MAAM,+CAIJC,UAAYC,KAAKC,MAAM,IAAIT,KAAKI,MAAMM,UAAY,KAExDlC,KAAKmC,KAAK,CAAC,CACPC,WAAY,oCACZC,KAAM,CACFC,SAAUnC,OAAOmC,SACjBC,OAAQpC,OAAOoC,OACfC,YAAad,OACbe,WAAYV,WAEhBW,KAAM,iBACIC,IAAMtC,SAASuC,cAAc,OACnCD,IAAIE,4CAAuCnB,QAC3CiB,IAAIG,YAAcpB,OAClBiB,IAAII,sBAAiBnB,MAErBxB,KAAK4C,aAAaL,IAAKpC,SACvBC,MAAMS,MAAMK,QAAU,QAE1B2B,KAAMhD,aAAaiD,gBAK3B7C,SAASO,iBAAiB,SAAUC,IAC3BL,MAAM2C,SAAStC,EAAEuC,SAAWvC,EAAEuC,SAAW7C,UAC1CC,MAAMS,MAAMK,QAAU,WAK9BtB,KAAKmC,KAAK,CAAC,CACPC,WAAY,oCACZC,KAAM,CACFC,SAAUnC,OAAOmC,SACjBC,OAAQpC,OAAOoC,QAEnBG,KAAM,SAASW,SACXA,QAAQC,SAAQC,UAENC,QADI,IAAIhC,KAAoB,IAAf+B,EAAEd,YACHgB,cAAcC,MAAM,KAAK,GAErCf,IAAMtC,SAASuC,cAAc,OACnCD,IAAIE,4CAAuCU,EAAEf,aAC7CG,IAAIG,YAAcS,EAAEf,YACpBG,IAAII,sBAAiBS,SACrBpD,KAAK4C,aAAaL,IAAKpC,aAG/B0C,KAAMhD,aAAaiD"}