{"version":3,"file":"databasecommunicator.min.js","sources":["../src/databasecommunicator.js"],"sourcesContent":["// blocks/revisionmanager/amd/src/datacommunicator.js\n\ndefine(['jquery', 'core/ajax', 'core/notification'], function($, Ajax, Notification) {\n    return {\n        init: function(params) {\n            const grid = document.getElementById('rating-grid');\n            const plusBtn = document.getElementById('plusBtn');\n            const popup = document.getElementById('rating-popup');\n            const dateInput = document.getElementById('rating-date');\n            const valueInput = document.getElementById('rating-value');\n            const saveBtn = document.getElementById('rating-save');\n            //const chapterid = params.chapterid || null;\n\n            // === Show popup when clicking plus button ===\n            plusBtn?.addEventListener('click', (e) => {\n                const rect = plusBtn.getBoundingClientRect();\n                const containerRect = grid.getBoundingClientRect();\n                popup.style.position = 'absolute';\n                popup.style.left = `${rect.left - containerRect.left + grid.scrollLeft}px`;\n                popup.style.top = `${rect.top - containerRect.top + 45}px`;\n                popup.style.display = 'block';\n                dateInput.valueAsDate = new Date();\n                valueInput.value = '';\n            });\n\n            // === Save new rating to server ===\n            saveBtn?.addEventListener('click', () => {\n                const rating = parseInt(valueInput.value);\n                const date = dateInput.value;\n                var nextreview = $('#nextReview').val();\n                const pageurl = window.location.pathname + window.location.search;\n\n                if (isNaN(rating) || rating < 0 || rating > 5) {\n                    alert(\"Please enter a rating between 0 and 5\");\n                    return;\n                }\n\n                const timestamp = Math.floor(new Date(date).getTime() / 1000);\n\n                Ajax.call([{\n                    methodname: 'block_revisionmanager_save_rating',\n                    args: {\n                        courseid: params.courseid,\n                        pageid: params.pageid,\n                        ratingvalue: rating,\n                        ratingdate: timestamp,\n                        pageurl: pageurl,\n                        nextreview: nextreview,\n                        pagetitle: params.pagetitle,\n                        chapterid: params.chapterid\n                    },\n                    done: function() {\n                        const div = document.createElement('div');\n                        div.className = `rating-square bg-rating-${rating}`;\n                        div.textContent = rating;\n                        div.title = `Date: ${date}`;\n\n                        grid.insertBefore(div, plusBtn);\n                        popup.style.display = 'none';\n                    },\n                    fail: Notification.exception\n                }]);\n            });\n\n            // === Hide popup if clicking outside ===\n            document.addEventListener('click', (e) => {\n                if (!popup.contains(e.target) && e.target !== plusBtn) {\n                    popup.style.display = 'none';\n                }\n            });\n\n            // === Load existing ratings from server ===\n            Ajax.call([{\n                methodname: 'block_revisionmanager_get_ratings',\n                args: {\n                    courseid: params.courseid,\n                    pageid: params.pageid,\n                    chapterid: params.chapterid\n                },\n                done: function(ratings) {\n                    ratings.forEach(r => {\n                        const d = new Date(r.ratingdate * 1000);\n                        const dateStr = d.toISOString().split('T')[0];\n\n                        const div = document.createElement('div');\n                        div.className = `rating-square bg-rating-${r.ratingvalue}`;\n                        div.textContent = r.ratingvalue;\n                        div.title = `Date: ${dateStr}`;\n                        grid.insertBefore(div, plusBtn);\n                    });\n                },\n                fail: Notification.exception\n            }]);\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","init","params","grid","document","getElementById","plusBtn","popup","dateInput","valueInput","saveBtn","addEventListener","e","rect","getBoundingClientRect","containerRect","style","position","left","scrollLeft","top","display","valueAsDate","Date","value","rating","parseInt","date","nextreview","val","pageurl","window","location","pathname","search","isNaN","alert","timestamp","Math","floor","getTime","call","methodname","args","courseid","pageid","ratingvalue","ratingdate","pagetitle","chapterid","done","div","createElement","className","textContent","title","insertBefore","fail","exception","contains","target","ratings","forEach","r","dateStr","toISOString","split"],"mappings":"AAEAA,oDAAO,CAAC,SAAU,YAAa,sBAAsB,SAASC,EAAGC,KAAMC,oBAC5D,CACHC,KAAM,SAASC,cACLC,KAAOC,SAASC,eAAe,eAC/BC,QAAUF,SAASC,eAAe,WAClCE,MAAQH,SAASC,eAAe,gBAChCG,UAAYJ,SAASC,eAAe,eACpCI,WAAaL,SAASC,eAAe,gBACrCK,QAAUN,SAASC,eAAe,eAIxCC,MAAAA,SAAAA,QAASK,iBAAiB,SAAUC,UAC1BC,KAAOP,QAAQQ,wBACfC,cAAgBZ,KAAKW,wBAC3BP,MAAMS,MAAMC,SAAW,WACvBV,MAAMS,MAAME,eAAUL,KAAKK,KAAOH,cAAcG,KAAOf,KAAKgB,iBAC5DZ,MAAMS,MAAMI,cAASP,KAAKO,IAAML,cAAcK,IAAM,SACpDb,MAAMS,MAAMK,QAAU,QACtBb,UAAUc,YAAc,IAAIC,KAC5Bd,WAAWe,MAAQ,MAIvBd,MAAAA,SAAAA,QAASC,iBAAiB,SAAS,WACzBc,OAASC,SAASjB,WAAWe,OAC7BG,KAAOnB,UAAUgB,UACnBI,WAAa9B,EAAE,eAAe+B,YAC5BC,QAAUC,OAAOC,SAASC,SAAWF,OAAOC,SAASE,UAEvDC,MAAMV,SAAWA,OAAS,GAAKA,OAAS,cACxCW,MAAM,+CAIJC,UAAYC,KAAKC,MAAM,IAAIhB,KAAKI,MAAMa,UAAY,KAExDzC,KAAK0C,KAAK,CAAC,CACPC,WAAY,oCACZC,KAAM,CACFC,SAAU1C,OAAO0C,SACjBC,OAAQ3C,OAAO2C,OACfC,YAAarB,OACbsB,WAAYV,UACZP,QAASA,QACTF,WAAYA,WACZoB,UAAW9C,OAAO8C,UAClBC,UAAW/C,OAAO+C,WAEtBC,KAAM,iBACIC,IAAM/C,SAASgD,cAAc,OACnCD,IAAIE,4CAAuC5B,QAC3C0B,IAAIG,YAAc7B,OAClB0B,IAAII,sBAAiB5B,MAErBxB,KAAKqD,aAAaL,IAAK7C,SACvBC,MAAMS,MAAMK,QAAU,QAE1BoC,KAAMzD,aAAa0D,gBAK3BtD,SAASO,iBAAiB,SAAUC,IAC3BL,MAAMoD,SAAS/C,EAAEgD,SAAWhD,EAAEgD,SAAWtD,UAC1CC,MAAMS,MAAMK,QAAU,WAK9BtB,KAAK0C,KAAK,CAAC,CACPC,WAAY,oCACZC,KAAM,CACFC,SAAU1C,OAAO0C,SACjBC,OAAQ3C,OAAO2C,OACfI,UAAW/C,OAAO+C,WAEtBC,KAAM,SAASW,SACXA,QAAQC,SAAQC,UAENC,QADI,IAAIzC,KAAoB,IAAfwC,EAAEhB,YACHkB,cAAcC,MAAM,KAAK,GAErCf,IAAM/C,SAASgD,cAAc,OACnCD,IAAIE,4CAAuCU,EAAEjB,aAC7CK,IAAIG,YAAcS,EAAEjB,YACpBK,IAAII,sBAAiBS,SACrB7D,KAAKqD,aAAaL,IAAK7C,aAG/BmD,KAAMzD,aAAa0D"}